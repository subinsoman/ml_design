events {
    worker_connections 1024;
}

http {
    # Add resolver for dynamic hostname resolution
    resolver 127.0.0.11 valid=10s;

    log_format custom_log '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          '"$upstream_addr" "$upstream_status" '
                          '"$request_uri" -> "$uri"';
   
    # Use variables for upstream servers to enable dynamic resolution
    upstream mlflow {
        server mlflow:5000;
    }
    
    upstream minio_s3 {
        least_conn;
        server minio:9001;
    }

    upstream code_server {
        server code:8080;
    }
    upstream airflow {
        server airflow:8080;
    }
    upstream ecr{
        server registry-ui:8080;
    }
    upstream seahorse{
        server proxy:33321;
    }

    server {
        listen 8080;
        listen [::]:8080;
        server_name localhost;
         sub_filter '<body >' '<body>

            <!-- Navbar -->
            <nav style="background-color: #fff; border-bottom: 1px solid #dadce0; box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; height: 70px; font-family: Arial, sans-serif;">
            <div style="display: flex; align-items: center; justify-content: space-between; height: 100%; width: 100%; padding: 0 24px;">
                
                <!-- Logo Left -->
                <div style="display: flex; align-items: center; height: 100%;">
                <svg width="300" height="80" viewBox="0 0 400 100" xmlns="http://www.w3.org/2000/svg">
                
                    <text x="110" y="60" font-family="Arial, sans-serif" font-size="20" fill="#4285f4">6D Technologies®</text>
                    <text x="110" y="80" font-family="Arial, sans-serif" font-size="10" fill="#5f6368">Smart Ideas, Delivered</text>
                </svg>
                </div>
                
                <!-- Menu Right (no list) -->
                <div style="display: flex; align-items: center; gap: 20px; font-size: 18px; font-weight: 500;">
                <a href="/mlflow/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">MLflow</a>
                <a href="/minio/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">MinIO</a>
                <a href="/code/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">Code</a>
                <a href="/airflow/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">Airflow</a>
                 <a href="/ecr/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">Registary</a>
                <a href="/about" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">About</a>
                </div>
            </div>
            </nav>

            <!-- Navbar Hover Effect -->
            <style>
            nav a:hover {
                background-color: #f8f9fa;
                color: #1a73e8;
            }
            </style>

            <!-- Adjust content to account for fixed navbar -->
            <style>
            body {
                margin-top: 70px;
            }
            </style>';
        sub_filter '<body>' '<body>

            <!-- Navbar -->
            <nav style="background-color: #fff; border-bottom: 1px solid #dadce0; box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; height: 70px; font-family: Arial, sans-serif;">
            <div style="display: flex; align-items: center; justify-content: space-between; height: 100%; width: 100%; padding: 0 24px;">
                
                <!-- Logo Left -->
                <div style="display: flex; align-items: center; height: 100%;">
                <svg width="300" height="80" viewBox="0 0 400 100" xmlns="http://www.w3.org/2000/svg">
                
                    <text x="110" y="60" font-family="Arial, sans-serif" font-size="20" fill="#4285f4">6D Technologies®</text>
                    <text x="110" y="80" font-family="Arial, sans-serif" font-size="10" fill="#5f6368">Smart Ideas, Delivered</text>
                </svg>
                </div>
                
                <!-- Menu Right (no list) -->
                <div style="display: flex; align-items: center; gap: 20px; font-size: 18px; font-weight: 500;">
                <a href="/mlflow/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">MLflow</a>
                <a href="/minio/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">MinIO</a>
                <a href="/code/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">Code</a>
                 <a href="/airflow/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">Airflow</a>
                <a href="/ecr/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">Registary</a>
                <a href="/about" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">About</a>
                </div>
            </div>
            </nav>

            <!-- Navbar Hover Effect -->
            <style>
            nav a:hover {
                background-color: #f8f9fa;
                color: #1a73e8;
            }
            </style>

            <!-- Adjust content to account for fixed navbar -->
            <style>
            body {
                margin-top: 70px;
            }
            </style>';
        sub_filter '<body aria-label="">' '<body aria-label="">

            <!-- Navbar -->
            <nav style="background-color: #fff; border-bottom: 1px solid #dadce0; box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; height: 70px; font-family: Arial, sans-serif;">
            <div style="display: flex; align-items: center; justify-content: space-between; height: 100%; width: 100%; padding: 0 24px;">
                
                <!-- Logo Left -->
                <div style="display: flex; align-items: center; height: 100%;">
                <svg width="300" height="80" viewBox="0 0 400 100" xmlns="http://www.w3.org/2000/svg">
                
                    <text x="110" y="60" font-family="Arial, sans-serif" font-size="20" fill="#4285f4">6D Technologies®</text>
                    <text x="110" y="80" font-family="Arial, sans-serif" font-size="10" fill="#5f6368">Smart Ideas, Delivered</text>
                </svg>
                </div>
                
                <!-- Menu Right (no list) -->
                <div style="display: flex; align-items: center; gap: 20px; font-size: 18px; font-weight: 500;">
                <a href="/mlflow/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">MLflow</a>
                <a href="/minio/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">MinIO</a>
                <a href="/code/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">Code</a>
                <a href="/airflow/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">Airflow</a>
                 <a href="/ecr/" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">Registary</a>
                <a href="/about" style="color: #5f6368; text-decoration: none; padding: 10px 16px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;">About</a>
                </div>
            </div>
            </nav>

            <!-- Navbar Hover Effect -->
            <style>
            nav a:hover {
                background-color: #f8f9fa;
                color: #1a73e8;
            }
            </style>

            <!-- Adjust content to account for fixed navbar -->
            <style>
            body {
                margin-top: 70px !important;
            }
            .monaco-workbench.web {
             margin-top: 79px !important;
            }
            </style>';    
            

        sub_filter_once off;

        # Enable logging
        access_log /var/log/nginx/access.log custom_log;
        error_log /var/log/nginx/error.log;

        # Proxy for MLflow
        location /mlflow/ {
            proxy_pass http://mlflow/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;
        }

        # Proxy for MinIO S3 API
        location /minio/ {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300s;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            client_max_body_size 0;
            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding off;
            proxy_pass http://minio_s3/;
        }
        
        # Proxy for Code Server
        location /code/ {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300s;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Accept-Encoding "";
            client_max_body_size 0;
            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding off;
            proxy_pass http://code_server/;
            
        }
        location /airflow/ {
           proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300s;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Accept-Encoding "";
            client_max_body_size 0;
            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding off;
            proxy_pass http://airflow;
            
        }
        location /ecr/ {
           proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300s;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Accept-Encoding "";
            client_max_body_size 0;
            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding off;
            proxy_pass http://ecr/;
            
        }

        # Health check endpoint
        location /health {
            return 200 "nginx is running\n";
            add_header Content-Type text/plain;
        }

        # Documentation endpoint
        location /docs {
            return 200 "Services Documentation\n- MLflow: /mlflow/\n- MinIO: /minio/\n- Code Server: /code/\n- Health Check: /health\n";
            add_header Content-Type text/plain;
        }

        # About endpoint
        location /about {
            return 200 "6D Technologies® - Smart Ideas, Delivered\nMLOps Platform with MLflow, MinIO, and Code Server\n";
            add_header Content-Type text/plain;
        }

        # Default location for other requests
        location / {
            proxy_pass http://seahorse/;
        }
    }
}